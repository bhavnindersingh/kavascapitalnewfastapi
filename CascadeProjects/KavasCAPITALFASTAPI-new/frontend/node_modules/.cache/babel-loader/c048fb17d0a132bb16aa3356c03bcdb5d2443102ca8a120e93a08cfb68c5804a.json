{"ast":null,"code":"import _objectSpread from\"C:/Users/inder/CascadeProjects/KavasCAPITALFASTAPI-new/frontend/node_modules/@babel/runtime/helpers/esm/objectSpread2.js\";import{useEffect,useState,useCallback}from'react';import{webSocketService}from'../services/websocket';import{useDispatch}from'react-redux';import{setOptionChainData,setError,setLoading}from'../store/slices/optionChainSlice';export function useMarketData(symbol,expiry){const dispatch=useDispatch();const[instrumentTokens,setInstrumentTokens]=useState([]);const[isLoading,setIsLoading]=useState(true);const[error,setLocalError]=useState(null);const handleMarketData=useCallback(message=>{try{if(message.type==='MARKET_DATA'&&message.data){const marketData=message.data;dispatch(setOptionChainData(prevState=>{if(!prevState)return null;const updatedStrikes=prevState.strikes.map(strike=>{var _strike$call,_strike$put;if(((_strike$call=strike.call)===null||_strike$call===void 0?void 0:_strike$call.instrument_token)===marketData.instrument_token){return _objectSpread(_objectSpread({},strike),{},{call:_objectSpread(_objectSpread({},strike.call),{},{ltp:marketData.last_price,oi:marketData.oi,change:marketData.change,volume:marketData.volume})});}if(((_strike$put=strike.put)===null||_strike$put===void 0?void 0:_strike$put.instrument_token)===marketData.instrument_token){return _objectSpread(_objectSpread({},strike),{},{put:_objectSpread(_objectSpread({},strike.put),{},{ltp:marketData.last_price,oi:marketData.oi,change:marketData.change,volume:marketData.volume})});}return strike;});return _objectSpread(_objectSpread({},prevState),{},{strikes:updatedStrikes});}));}else if(message.type==='OPTION_CHAIN'&&message.data){const chainData=message.data;dispatch(setOptionChainData(chainData));setLocalError(null);setIsLoading(false);// Extract instrument tokens\nconst tokens=[];chainData.strikes.forEach(strike=>{var _strike$call2,_strike$put2;if((_strike$call2=strike.call)!==null&&_strike$call2!==void 0&&_strike$call2.instrument_token){tokens.push(strike.call.instrument_token);}if((_strike$put2=strike.put)!==null&&_strike$put2!==void 0&&_strike$put2.instrument_token){tokens.push(strike.put.instrument_token);}});setInstrumentTokens(tokens);}else if(message.type==='ERROR'){setLocalError(message.error||'Unknown error occurred');setIsLoading(false);dispatch(setError(message.error||'Unknown error occurred'));}}catch(err){const errorMessage=err instanceof Error?err.message:'Unknown error occurred';console.error('Error handling market data:',errorMessage);setLocalError(errorMessage);setIsLoading(false);dispatch(setError(errorMessage));}},[dispatch]);// Connect to WebSocket and set up handlers\nuseEffect(()=>{setIsLoading(true);setLocalError(null);dispatch(setLoading(true));dispatch(setError(null));webSocketService.connect(symbol,expiry);webSocketService.addMessageHandler(handleMarketData);return()=>{webSocketService.removeMessageHandler(handleMarketData);webSocketService.disconnect();};},[symbol,expiry,handleMarketData,dispatch]);// Subscribe to instruments\nuseEffect(()=>{if(instrumentTokens.length>0){console.log('Subscribing to instruments:',instrumentTokens);webSocketService.subscribe(instrumentTokens);return()=>{console.log('Unsubscribing from instruments:',instrumentTokens);webSocketService.unsubscribe(instrumentTokens);};}},[instrumentTokens]);return{error:error,isLoading};}","map":{"version":3,"names":["useEffect","useState","useCallback","webSocketService","useDispatch","setOptionChainData","setError","setLoading","useMarketData","symbol","expiry","dispatch","instrumentTokens","setInstrumentTokens","isLoading","setIsLoading","error","setLocalError","handleMarketData","message","type","data","marketData","prevState","updatedStrikes","strikes","map","strike","_strike$call","_strike$put","call","instrument_token","_objectSpread","ltp","last_price","oi","change","volume","put","chainData","tokens","forEach","_strike$call2","_strike$put2","push","err","errorMessage","Error","console","connect","addMessageHandler","removeMessageHandler","disconnect","length","log","subscribe","unsubscribe"],"sources":["C:/Users/inder/CascadeProjects/KavasCAPITALFASTAPI-new/frontend/src/hooks/useMarketData.ts"],"sourcesContent":["import { useEffect, useState, useCallback } from 'react';\nimport { webSocketService } from '../services/websocket';\nimport { OptionChainData, WSMessage, MarketData } from '../types/options';\nimport { useDispatch } from 'react-redux';\nimport { setOptionChainData, setError, setLoading } from '../store/slices/optionChainSlice';\n\nexport function useMarketData(symbol: string, expiry: string) {\n    const dispatch = useDispatch();\n    const [instrumentTokens, setInstrumentTokens] = useState<number[]>([]);\n    const [isLoading, setIsLoading] = useState<boolean>(true);\n    const [error, setLocalError] = useState<string | null>(null);\n\n    const handleMarketData = useCallback((message: WSMessage) => {\n        try {\n            if (message.type === 'MARKET_DATA' && message.data) {\n                const marketData = message.data as MarketData;\n                dispatch(setOptionChainData((prevState: OptionChainData | null) => {\n                    if (!prevState) return null;\n\n                    const updatedStrikes = prevState.strikes.map(strike => {\n                        if (strike.call?.instrument_token === marketData.instrument_token) {\n                            return {\n                                ...strike,\n                                call: {\n                                    ...strike.call,\n                                    ltp: marketData.last_price,\n                                    oi: marketData.oi,\n                                    change: marketData.change,\n                                    volume: marketData.volume,\n                                },\n                            };\n                        }\n                        if (strike.put?.instrument_token === marketData.instrument_token) {\n                            return {\n                                ...strike,\n                                put: {\n                                    ...strike.put,\n                                    ltp: marketData.last_price,\n                                    oi: marketData.oi,\n                                    change: marketData.change,\n                                    volume: marketData.volume,\n                                },\n                            };\n                        }\n                        return strike;\n                    });\n\n                    return {\n                        ...prevState,\n                        strikes: updatedStrikes,\n                    };\n                }));\n            } else if (message.type === 'OPTION_CHAIN' && message.data) {\n                const chainData = message.data as OptionChainData;\n                dispatch(setOptionChainData(chainData));\n                setLocalError(null);\n                setIsLoading(false);\n\n                // Extract instrument tokens\n                const tokens: number[] = [];\n                chainData.strikes.forEach(strike => {\n                    if (strike.call?.instrument_token) {\n                        tokens.push(strike.call.instrument_token);\n                    }\n                    if (strike.put?.instrument_token) {\n                        tokens.push(strike.put.instrument_token);\n                    }\n                });\n                setInstrumentTokens(tokens);\n            } else if (message.type === 'ERROR') {\n                setLocalError(message.error || 'Unknown error occurred');\n                setIsLoading(false);\n                dispatch(setError(message.error || 'Unknown error occurred'));\n            }\n        } catch (err) {\n            const errorMessage = err instanceof Error ? err.message : 'Unknown error occurred';\n            console.error('Error handling market data:', errorMessage);\n            setLocalError(errorMessage);\n            setIsLoading(false);\n            dispatch(setError(errorMessage));\n        }\n    }, [dispatch]);\n\n    // Connect to WebSocket and set up handlers\n    useEffect(() => {\n        setIsLoading(true);\n        setLocalError(null);\n        dispatch(setLoading(true));\n        dispatch(setError(null));\n\n        webSocketService.connect(symbol, expiry);\n        webSocketService.addMessageHandler(handleMarketData);\n\n        return () => {\n            webSocketService.removeMessageHandler(handleMarketData);\n            webSocketService.disconnect();\n        };\n    }, [symbol, expiry, handleMarketData, dispatch]);\n\n    // Subscribe to instruments\n    useEffect(() => {\n        if (instrumentTokens.length > 0) {\n            console.log('Subscribing to instruments:', instrumentTokens);\n            webSocketService.subscribe(instrumentTokens);\n\n            return () => {\n                console.log('Unsubscribing from instruments:', instrumentTokens);\n                webSocketService.unsubscribe(instrumentTokens);\n            };\n        }\n    }, [instrumentTokens]);\n\n    return {\n        error: error,\n        isLoading\n    };\n}\n"],"mappings":"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","ignoreList":[]},"metadata":{},"sourceType":"module","externalDependencies":[]}